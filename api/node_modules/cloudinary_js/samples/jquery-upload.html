<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Direct jQuery upload</title>
    <script src="https://code.jquery.com/jquery-3.1.0.js"></script>
</head>
<body>
<h1>Upload to Cloudinary with FormData</h1>
<div>
    <p>

        <label for="cloud_name">Cloud name: <input type="text" name="cloud_name" id="cloud_name"></label></p>
</div>
<form action="" id="upload">
    <fieldset>
        <legend>Upload example</legend>
        <p>
            <label for="upload_preset">Unsigned upload Preset: <input type="text" name="upload_preset" id="upload_preset">(set it <a href="https://cloudinary.com/console/settings/upload#upload_presets">here</a>)</label>
        </p>
        <p>
            <label >Select your photo:
                <input type="file" name="file" id="file"></label>
        </p>

        <p>
            <input type="submit" value="Submit" />
        </p>
        <img id="uploaded">
        <div id="results"></div>
    </fieldset>
</form>





<script type="text/javascript">
    window.ajaxSuccess = function (responseText) {
        response = JSON.parse(responseText);
        console.log("ajaxSuccess", typeof this.responseText);
        $('uploaded').setAttr("src", response["secure_url"]);
        $('results').append( this.responseText);
        $('results').append( '<br>');
    }

    //window.AJAXSubmit = function (formElement) {
    console.log("starting AJAXSubmit");
    $('#upload').submit(function(event){
        // Stop form from submitting normally
        cloudName = $('#cloud_name').val();
        if( cloudName == '') {
            $('#results').append('You must set the cloud name first<br>');
            return;
        }
        url = "https://api.cloudinary.com/v1_1/" + cloudName + "/image/upload";
        console.log("url", url);
        event.preventDefault();
//    data = $('#upload').serialize();
        data = new FormData(this);
        data.forEach( (v,k) => console.log(k, v));
        /*	  data = {
         upload_preset: $('#upload_preset').val(),
         file: $('#file')[0].files[0]

         };*/
        // $.post(url, data, ajaxSuccess);
        $.ajax({
                   url: url,
                   type: 'POST',
                   data: data,
                   dataType: 'json',
                   headers: {
                       'X-Requested-With': 'XMLHttpRequest',
                       'X-Unique-Upload-Id': (Math.random() * 10000000000).toString(16)
                   },
                   processData: false,
                  contentType: false,
                   crossDomain: true
               }).done(ajaxSuccess)
                .fail(console.error);
    });

    /*
     var xhr = new XMLHttpRequest();
     xhr.onload = ajaxSuccess;
     xhr.open("post", "https://api.cloudinary.com/v1_1/" + cloudName + "/image/upload");
     xhr.send(new FormData(formElement));
     */
    //}
</script>
</body>
</html>